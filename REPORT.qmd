---
title: "How does commuting behavior vary across different socio-demographic characteristics, income levels, and infrastructural factors in France?"
author: "Mathilde VALLAT, Yesmine HACHANA"
format: pdf
editor: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
# Load knitr package
library(knitr)

# Set global chunk options
knitr::opts_chunk$set(
  echo = FALSE,    # Hide all code
  message = FALSE, # Suppress messages
  warning = FALSE  # Suppress warnings
)
```

[Link to the github
project](https://github.com/jemappelleyesmine/final_project)

# Introduction

As our modern societies have increased the distance between home and
workplace for most, commuting has become part of our daily routine. It
influences a countries energy use, urban development, and environmental
sustainability. In France, transportation accounts for a significant
share of national greenhouse gas (GHG) emissions (in 2021, transport
emissions amount to 126.0 Mt CO2 eq, equivalent to 30% of the national
total, source 1), with private vehicles being a major contributor (53%
in 2021, i.e. 66.4 Mt CO2 eq., source 1). Shifting commuters from
high-carbon modes like cars to lower-carbon options like public
transport, cycling, or walking is essential for meeting climate goals
such as those outlined in the Paris Agreement. France has committed to
reducing its carbon footprint, and understanding commuter behavior is
vital for designing effective policies to encourage sustainable
transportation choices. Beyond climate change, transport choices affect
both public health (e.g., air quality, physical activity) and quality of
life (e.g., time spent commuting, stress levels). Such that aligning
commuter preferences with sustainable goals can create co-benefits, such
as improved urban mobility, reduced traffic congestion, and healthier
lifestyles.

We are interested in this topic because commuting behavior reflects the
complex interplay of socio-economic realities, urban design, and
environmental priorities, shaping both our daily lives and the future of
our planet. Understanding commuting behavior can help policymakers
design targeted interventions that promote sustainable and equitable
transport systems. For society, this research supports efforts to reduce
emissions, improve public health, and ensure accessible mobility for
all, while contributing valuable insights to the academic study of
transport behavior, particularly within the French context.

# Research question

Our research question explores how commuting behavior varies across
different socio-economic, geographic, and infrastructural factors in
France. This project aims to identify patterns and differences in
commuting choices based on key factors, such as urbanization, income,
population density, commuting distance, and accessibility to
transportation infrastructure, using large publicly available datasets
with varying levels of aggregation. By cleaning, harmonizing, and
analyzing these datasets, we will summarize variables and visualize
relationships to better understand how these factors correlate with
commuting behavior. While this study does not attempt to infer causal
relationships, it seeks to produce clear visualizations and highlight
meaningful patterns that can inform policymakers and contribute to
ongoing research on transportation behavior in France.

Here are some factors that might influence commuting behavior and the
associated variables that we have thought of:

-   **Socio-demographic factors**: age, gender, educational attainment
    and socio-professional category
-   **Income levels**: median living standard
-   **Infrastructures and urban/rural areas**: proximity to transport
    infrastructure and population density
-   **Commuting distances**: commuting destinations
-   **Car ownership**: share of houselholds owning a car

Our project involves several steps: firstly, we collect, store, and
organize datasets in a GitHub repository. Since datasets are aggregated
at varying levels (e.g., “commune” vs. “intercommunal” and with
"lon/lat"), we then have to harmonize these differences using data
management methods seen in class. In parallel, we look for missing or
inconsistent data that may complicate our data analysis. After this, we
start initial data exploration, summarize variables using R and
ultimately generate visualizations to identify patterns.

# Datasets

Our analysis leverages multiple datasets from various reliable sources,
providing a comprehensive view of commuting behavior in France. From
INSEE's "Statistiques Locales" platform, we use demographic data on
population and density, income levels, and commuting patterns,
aggregated at intercommunal or municipal levels. These datasets offer
insights into variables such as population density, median income, car
ownership, and the use of different transport modes. Additionally, an
experimental dataset from transport.data.gouv.fr provides geolocated
information on public transport stops, enriching our understanding of
infrastructure accessibility. Further, the INSEE NAV2B dataset from the
2017 census highlights transport choices by employed individuals aged 15
and above, disaggregated by gender and geography. Lastly, the 2024
professional mobility dataset offers granular data on commuting
patterns, household vehicle ownership, and education levels, linking
residence and workplace at the municipal level. These diverse datasets,
despite differing levels of aggregation, collectively form the
foundation for our exploration of commuting behavior in France.

```{r}
library(vroom)
library(tidyverse)
library(here)
library(dplyr)
library(ggplot2)
library(tidyr)
here::i_am("Final_Project_Commuter_behavior.Rproj")

source <- "https://www.data.gouv.fr/fr/datasets/r/69cf54c6-6591-4920-b1d6-2a5292964606"
local_name <- "stops_france.csv.gz"
local_dir <- "data"
## is the directory available?
if (!dir.exists(here(local_dir))) {
  ## create the directory if needed
  dir.create(here(local_dir))
}
## is the file available?
if (!file.exists(here(local_dir, local_name))) {
  ## we need to download it
  stops_france <- vroom(source)
  ## let's save the file to avoid useless downloading
  vroom_write(stops_france, here(local_dir, local_name), delim = ",")
} else {
  ## we need only to load it
  stops_france <- vroom(here(local_dir, local_name))
}
```

```{r}
#Loading mob_pro
library(zip)
# Define variables
source <- "https://www.insee.fr/fr/statistiques/fichier/8205896/RP2021_mobpro.zip"
local_name <- "RP2021_mobpro.zip"
local_dir <- "data"
csv1_name <- "FD_MOBPRO_2021.csv"
csv2_name <- "varmod_mobpro_2021.csv"
# Check if the directory exists, create if not
if (!dir.exists(here(local_dir))) {
  dir.create(here(local_dir))
}
# Check if the ZIP file exists locally
if (!file.exists(here(local_dir, local_name))) {
  # Download the ZIP file
  download.file(source, destfile = here(local_dir, local_name), mode = "wb")
}
# Unzip the file
unzip(here(local_dir, local_name), exdir = here(local_dir))
# Load the first CSV file
mob_pro <- vroom(here(local_dir, csv1_name))
# Load the second CSV file
var_mob_pro <- vroom(here(local_dir, csv2_name))
```

```{r}
#Loading iltduu_sexe_trans

# Define variables
source <- "https://www.insee.fr/fr/statistiques/fichier/4515510/BTT_TD_NAV2B_2017.zip"
local_name <- "BTT_TD_NAV2B_2017.zip"
local_dir <- "data"
csv_name <- "BTT_TD_NAV2B_2017.CSV"
# Check if the directory exists, create it if not
if (!dir.exists(here(local_dir))) {
  dir.create(here(local_dir))
}
# Check if the ZIP file exists locally
if (!file.exists(here(local_dir, local_name))) {
  # Download the ZIP file
  download.file(source, destfile = here(local_dir, local_name), mode = "wb")
}
# Unzip the file
unzip(here(local_dir, local_name), exdir = here(local_dir))
# Load the specified CSV file
iltduu_sexe_trans <- vroom(here(local_dir, csv_name))
```

```{r}
#Loading the local files
demo <- vroom(here("data", "INSEE_Statistiques_locales_demographie.csv"))
revenus <- vroom(here("data","INSEE_Statistiques_locales_menages_fiscaux_niveau_de_vie.csv"))
local_mob <- vroom(here("data","INSEE_Statistiques_locales_territoires_ville_quartiers.csv"))
```

**Summary Table**

```{r echo = FALSE, results='asis'}
# Load required libraries
library(tibble)
library(knitr)

# Define datasets
datasets <- list(
  iltduu_sexe_trans = iltduu_sexe_trans,
  stops_france = stops_france,
  mob_pro = mob_pro,
  var_mob_pro = var_mob_pro,
  revenus = revenus,
  demo = demo,
  local_mob = local_mob
)

  
  # Create a summary table for all datasets
summary_table <- do.call(rbind, lapply(names(datasets), function(name) {
  data <- datasets[[name]]
  tibble(
    Dataset = name,
    `Number of Rows` = nrow(data),
    `Number of Columns` = ncol(data)
  )
}))

 # Print a heading and the table in LaTeX format
print(knitr::kable(summary_table, format = "pipe"))
```

# Data Analysis

The data analysis aims to uncover patterns in commuting behavior across
France by exploring socio-demographic, economic, geographic, and
infrastructural variables. By systematically examining these factors, we
seek to identify trends and relationships that shape commuting choices.

Before seeing visually how these factors relate to commuting behavior, let's try to find a model that is appropriate to explain commuting behavior. Here we use the average French intercommunauté.

```{r}
model_average = lm(formula = public_transport_share ~ population_density_2021 + 
     share_household_car + median_living_standard_2021 + female_share + 
     employes_share + cap_bep_share + other_commune_same_dept_share + 
     age_45_54_share, data = final_dataset_cleaned2.0)
summary(model_average)
```
This models seems to poorly reflect what's going on. Let's see if that has something to do with the fact that our dataset shows everything in shares.
```{r}

# Identify columns to exclude and the multiplier column
columns_to_exclude <- c("code_epci", "intercommunal_label", "population_density_2021", "intercommunal_population_2021", "nb_stops", "median_living_standard_2021")
multiplier_column <- "intercommunal_population_2021"

# Create a new dataset where selected columns are multiplied
new_dataset <- final_dataset_cleaned2.0
columns_to_transform <- setdiff(names(final_dataset_cleaned2.0), c(columns_to_exclude, multiplier_column))

# Apply the transformation
new_dataset[columns_to_transform] <- lapply(columns_to_transform, function(col) {
  final_dataset_cleaned2.0[[col]] / 100 * final_dataset_cleaned2.0[[multiplier_column]]
})
names(new_dataset) <- gsub("share", "value", names(new_dataset))

# Choosing appropriate types
new_dataset <- new_dataset %>%
  mutate(
    # Convert to factors
    intercommunal_label = as.factor(intercommunal_label),
    
    # Ensure ID columns remain as integers
    code_epci = as.integer(code_epci),
    
    # Continuous numeric columns (already numeric, ensuring they stay so)
    across(c(intercommunal_population_2021, population_density_2021, 
             nb_stops, value_household_car, median_living_standard_2021), as.numeric),
    
    # Ensure proportion/percentage columns are numeric
    across(matches("_value$"), as.numeric)
  )

write.csv(new_dataset, "new_dataset.csv", row.names = FALSE)

```

```{r}
#apply model again avergae French
model_average2_pt = lm(formula = public_transport_value ~ population_density_2021 + 
     value_household_car + median_living_standard_2021 + female_value + 
     employes_value + cap_bep_value + other_commune_same_dept_value + 
     age_45_54_value, data = new_dataset)
summary(model_average2_pt)
```
```{r}
#apply model on car_truck_van
model_average2_car = lm(formula = car_truck_van_value ~ population_density_2021 + 
     public_transport_value + median_living_standard_2021 + female_value + 
     employes_value + cap_bep_value + other_commune_same_dept_value + 
     age_45_54_value, data = new_dataset)
summary(model_average2_car)
```

## Socio-demographic factors

Hypothesis:

-   Younger individuals are more likely to use active modes of transport
    (e.g., cycling, walking) or public transport, while older
    individuals may prefer private vehicles.

-   Men may have a higher likelihood of using private vehicles or
    motorized two-wheelers, whereas women may rely more on public
    transport.

-   Higher educational attainment correlates with increased use of
    sustainable transport modes due to environmental awareness.

-   Socio-professional categories determine affordability and
    accessibility: higher-income professionals may prefer private
    vehicles, while workers in intermediate or lower categories might
    rely on public transport.

### Age
```{r}
# Filter out "Not Applicable" and focus on 10-year age slices
mob_pro_cleaned$age_group <- cut(
  as.numeric(sub("(\\d+).*", "\\1", mob_pro_cleaned$age_five_year_slice)),
  breaks = seq(15, 95, by = 10),
  right = FALSE,
  include.lowest = TRUE,
  labels = paste(seq(15, 85, by = 10), seq(24, 94, by = 10), sep = "-")
)

# Remove rows with NA age groups and "Not Applicable" in main_transportation_work
mob_pro_cleaned <- subset(mob_pro_cleaned, !is.na(age_group) & main_transportation_work != "Not Applicable")
```

```{r}

# Create the stacked bar plot
ggplot(data = mob_pro_cleaned, aes(x = age_group, fill = main_transportation_work)) +
  geom_bar(position = "stack") +
  labs(
    title = "Main Transportation to Work by Age Group (10-Year Slices)",
    x = "Age Group",
    y = "Count of Transportation Modes",
    fill = "Mode of Transportation"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )
```

Doesn't allow for valuable analysis.

### Gender

```{r}
# Create the faceted bar plot
ggplot(data = mob_pro_cleaned, aes(x = sexe, fill = main_transportation_work)) +
  geom_bar(position = "dodge") +
  labs(
    title = "Main Transportation to Work by Gender",
    x = "Gender",
    y = "Count of Transportation Modes",
    fill = "Mode of Transportation"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    plot.title = element_text(hjust = 0.5)
  ) +
  facet_wrap(~ main_transportation_work, scales = "free_y")

```

### Educational attainment

```{r}
# Melt the data for transportation modes grouped by broad educational attainment
melted_data_broad_education <- new_dataset %>%
  select(
    no_schooling_value,
    primary_or_lower_value,
    secondary_or_higher_value,
    cep_value,
    bepc_value,
    cap_bep_value,
    general_bac_value,
    professional_bac_value,
    bts_dut_value,
    bachelor_value,
    master_value,
    doctorate_value,
    no_transport_value,
    on_foot_value,
    bicycle_value,
    motorized_two_wheelers_value,
    car_truck_van_value,
    public_transport_value
  ) %>%
  pivot_longer(
    cols = c(no_schooling_value, primary_or_lower_value, secondary_or_higher_value,
             cep_value, bepc_value, cap_bep_value, general_bac_value, 
             professional_bac_value, bts_dut_value, bachelor_value, 
             master_value, doctorate_value),
    names_to = "Education_Level",
    values_to = "Education_Value"
  ) %>%
  pivot_longer(
    cols = c(no_transport_value, on_foot_value, bicycle_value, 
             motorized_two_wheelers_value, car_truck_van_value, 
             public_transport_value),
    names_to = "Transport_Mode",
    values_to = "Transport_Value"
  ) %>%
  mutate(
    Broad_Education_Level = case_when(
      Education_Level %in% c("no_schooling_value", "primary_or_lower_value", "secondary_or_higher_value") ~ "Group 1: No Schooling to Secondary",
      Education_Level %in% c("cep_value", "bepc_value", "cap_bep_value", "general_bac_value", "professional_bac_value") ~ "Group 2: CEP to Bac",
      Education_Level %in% c("bts_dut_value", "bachelor_value") ~ "Group 3: BTS/DUT to Bachelor",
      Education_Level %in% c("master_value", "doctorate_value") ~ "Group 4: Master to Doctorate",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(Broad_Education_Level)) # Remove NA Broad_Education_Level values

# Summarize transportation choices by broad educational attainment
summary_data_broad_education <- melted_data_broad_education %>%
  group_by(Broad_Education_Level, Transport_Mode) %>%
  summarise(Average_Value = mean(Transport_Value, na.rm = TRUE), .groups = "drop")

# Create the faceted bar plot
ggplot(summary_data_broad_education, aes(x = Broad_Education_Level, y = Average_Value, fill = Broad_Education_Level)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Transportation Choices by Broad Educational Attainment",
    x = "Broad Educational Attainment",
    y = "Average Value"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), # Rotate x-axis labels for clarity
    legend.position = "none" # Remove legend as Broad_Education_Level is on x-axis
  ) +
  facet_wrap(~ Transport_Mode, scales = "free_y") # Facet by Transport Mode

```

### Socio-professional category

## Income levels

Living standard

Hypothesis:

-   Wealthier households may prioritize comfort and convenience, opting
    for private cars or motorized transport.

-   Lower-income individuals may prefer public transport or walking due
    to affordability constraints.
    
```{r}
# Create income categories
final_dataset_cleaned2.0_2 <- final_dataset_cleaned2.0 %>%
  mutate(income_category = cut(
    median_living_standard_2021,
    breaks = quantile(median_living_standard_2021, probs = seq(0, 1, by = 0.25), na.rm = TRUE),
    labels = c("Low", "Mid-Low", "Mid-High", "High"),
    include.lowest = TRUE
  ))


# Melt the data for transportation modes
melted_data <- final_dataset_cleaned2.0_2 %>%
  select(
    income_category,
    no_transport_share,
    on_foot_share,
    bicycle_share,
    motorized_two_wheelers_share,
    car_truck_van_share,
    public_transport_share
  ) %>%
  pivot_longer(
    cols = c(no_transport_share, on_foot_share, bicycle_share, 
             motorized_two_wheelers_share, car_truck_van_share, 
             public_transport_share),
    names_to = "Transport_Mode",
    values_to = "Share"
  )

# Bar plot

ggplot(melted_data, aes(x = income_category, y = Share, fill = income_category)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Transportation Choices by Income Category",
    x = "Income Category",
    y = "Average Share"
  ) +
  theme_minimal() +
  theme(legend.position = "none") + # Remove legend since it's redundant with facets
  facet_wrap(~ Transport_Mode, scales = "free_y") # Facet by Transport_Mode

```

## Infrastructures and urban/rural areas

We want to use number of stops as an indicator of infrastructure. First we will see if that dataset seems reliable.
```{r}
model_stops = lm(formula = nb_stops ~ population_density_2021, data = data)
summary(model_stops)
```
A linear model does not explain the relationship between number of stops and density. NOW WE TRY ANOTHER MODEL

Using density as a proxy for urban/rural indicator proximity to
transport infrastructure and population density

Hypothesis:
Proximity to transport infrastructure and population density affect the
accessibility and practicality of transport modes.

-   Urban residents (higher density areas) are more likely to use public
    transport or active transport due to better availability of
    infrastructure and shorter travel distances.

-   Rural residents (lower density areas) are more dependent on private
    vehicles due to limited access to public transport options.

### Infrastructures

```{r}
# Scatterplot to visualize the relationship
library(ggplot2)

ggplot(final_dataset_cleaned2.0, aes(x = nb_stops, y = public_transport_share)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_smooth(method = "lm", color = "red") +
  labs(
    title = "Relationship Between Public Transport Share and Number of Stops",
    x = "Number of Stops",
    y = "Public Transport Share"
  ) +
  theme_minimal()
```


### Uban/rural areas

The threshold of 150 inhabitants per square kilometer comes from Insee's
official definition of urban units, which are used to differentiate
between urban and rural areas in France.

```{r}
final_dataset_cleaned2.0_3 <- final_dataset_cleaned2.0 %>%
  mutate(urban_rural = ifelse(population_density_2021 > 150, "Urban", "Rural"))

# Boxplot for Urban/Rural vs. Car Share for Work
ggplot(final_dataset_cleaned2.0_3, aes(x = urban_rural, y = car_truck_van_share)) +
  geom_boxplot() +
  labs(
    title = "Car Share for Work by Urban/Rural Classification",
    x = "Urban/Rural",
    y = "Car Share for Work"
  ) +
  theme_minimal()
```

```{r}
# Scatterplot for Public Transport Share vs. Population Density
ggplot(final_dataset_cleaned2.0, aes(x = population_density_2021, y = public_transport_share)) +
  geom_point() +
    geom_smooth(method = "lm", color = "blue", se = FALSE) +
  labs(
    title = "Public Transport Share vs. Population Density",
    x = "Population Density (2021)",
    y = "Public Transport Share"
  ) +
  theme_minimal()

# Scatterplot for Car Share vs. Population Density
ggplot(final_dataset_cleaned2.0, aes(x = population_density_2021, y = car_truck_van_share)) +
  geom_point() +
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  labs(
    title = "Car Share vs. Population Density",
    x = "Population Density (2021)",
    y = "Car Share for Work"
  ) +
  theme_minimal()
```


## Commuting distances

commuting destinations

**Hypothesis:**\
Commuting distances determine the feasibility of transport modes.

-   Shorter distances are associated with active modes (walking,
    cycling), while longer distances are more likely to necessitate the
    use of private vehicles or public transport.

-   Very long commutes may encourage reliance on private cars or trains,
    depending on infrastructure availability.

```{r}
# Create the faceted bar plot
ggplot(data = mob_pro_cleaned, aes(x = workplace_indicator, fill = main_transportation_work)) +
  geom_bar(position = "dodge") +
  labs(
    title = "Main Transportation to Work by Commuting Distance",
    x = "Commuting Distance",
    y = "Count of Transportation Modes",
    fill = "Mode of Transportation"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), # Rotate x-axis labels for clarity
    plot.title = element_text(hjust = 0.5)
  ) +
  facet_wrap(~ main_transportation_work, scales = "free_y")
```


## Car ownership

share of houselholds owning a car

**Hypothesis:**\
Car ownership directly influences the likelihood of using private
vehicles for commuting.

-   Households with cars are more likely to rely on them for commuting,
    especially in areas with limited public transport options.

-   Households without cars are more likely to depend on public
    transport, walking, or cycling for their commuting needs.
    
```{r}
# Exclude cases where share_household_car = 0
filtered_data_car <- final_dataset_cleaned2.0 %>%
  filter(share_household_car != 0)

# Create quantile-based categories for share_household_car
filtered_data_car <- filtered_data_car %>%
  mutate(
    share_household_car_category = cut(
      share_household_car,
      breaks = quantile(share_household_car, probs = seq(0, 1, by = 0.25), na.rm = TRUE),
      labels = c("Low Share", "Mid-Low Share", "Mid-High Share", "High Share"),
      include.lowest = TRUE
    )
  )

# Melt the data for transportation modes grouped by share_household_car categories
melted_data_car_share <- filtered_data_car %>%
  select(
    share_household_car_category,
    no_transport_share,
    on_foot_share,
    bicycle_share,
    motorized_two_wheelers_share,
    car_truck_van_share,
    public_transport_share
  ) %>%
  pivot_longer(
    cols = c(no_transport_share, on_foot_share, bicycle_share, 
             motorized_two_wheelers_share, car_truck_van_share, 
             public_transport_share),
    names_to = "Transport_Mode",
    values_to = "Transport_Value"
  )

# Summarize transportation choices by share_household_car categories
summary_data_car_share <- melted_data_car_share %>%
  group_by(share_household_car_category, Transport_Mode) %>%
  summarise(Average_Value = mean(Transport_Value, na.rm = TRUE), .groups = "drop")

# Create the faceted bar plot
ggplot(summary_data_car_share, aes(x = share_household_car_category, y = Average_Value, fill = share_household_car_category)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Transportation Choices by Share of Household Cars",
    x = "Household Car Share Category",
    y = "Average Value"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), # Rotate x-axis labels for clarity
    legend.position = "none" # Remove legend as categories are on x-axis
  ) +
  facet_wrap(~ Transport_Mode, scales = "free_y") # Facet by Transport Mode

```

    
# Discussion

-   Mention that some factors probably matter more than others. - use
    qui 2 test?
-   Would also be interesting to perform a causal analysis. However, we
    cannot account for all confounding variables.
-   Modeling to predict commuting behavior based on these variables.
-   Eventually try to measure the impact of remote working on commute
    behavior (compare pre and post covid data)

https://hbr.org/2019/12/why-its-so-hard-to-change-peoples-commuting-behavior

# Conclusion

# Sources

1.  https://www.statistiques.developpement-durable.gouv.fr/edition-numerique/chiffres-cles-transports-2023/20-emissions-de-gaz-a-effet#:\~:text=Les%20%C3%A9missions%20des%20transports%20a%C3%A9riens%20sont%20ainsi%20deux%20fois%20moins,de%20GES%20de%20la%20France.

2.  https://statistiques-locales.insee.fr/#view=map1&c=indicator
